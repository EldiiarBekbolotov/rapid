name: Release

on:
  push:
    tags:
      - 'v*'  # Push events matching v1.0, v20.15.10, etc.

jobs:
  build-mac:
    name: Build for macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        brew install qt@6 cmake
        echo "$(brew --prefix qt@6)/bin" >> $GITHUB_PATH
    
    - name: Build
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        cmake --build . --config Release -- -j$(sysctl -n hw.logicalcpu)
    
    - name: Package
      run: |
        mkdir -p packages/mac
        cd build
        cpack -G DragNDrop
        mv *.dmg ../packages/mac/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Rapid-macOS
        path: packages/mac/*.dmg
        if-no-files-found: error

  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt (using aqtinstall)
      run: |
        python -m pip install aqtinstall
        python -m aqt install-qt windows desktop 6.5.0 win64_msvc2019_64 -m qtwebengine
        echo "C:\\Qt\\6.5.0\\msvc2019_64\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release ..
        cmake --build . --config Release -- /m:$env:NUMBER_OF_PROCESSORS
    
    - name: Package
      run: |
        mkdir -p packages/windows
        cd build
        cpack -G WIX
        move *.msi ..\packages\windows\
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Rapid-Windows
        path: packages/windows/*.msi
        if-no-files-found: error

  release:
    name: Create Release
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
    - name: Download Mac Artifact
      uses: actions/download-artifact@v4
      with:
        name: Rapid-macOS
        path: artifacts/mac
    
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: Rapid-Windows
        path: artifacts/windows
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/mac/*.dmg
          artifacts/windows/*.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
